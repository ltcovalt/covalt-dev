---
const { apiPath } = Astro.props;

const rel = String(apiPath).replace(/^\/+|\/+$/g, '');
const modules = import.meta.glob('/docs/**/typedoc/README.md');
const typedocPath = `/docs/${rel}/typedoc/README.md`;
const loader = modules[typedocPath];

if (!loader) {
	throw new Error(`No TypeDoc README found at: ${typedocPath}`);
}

const mod = await loader();
const rawHtml = await mod.compiledContent?.();

if (!rawHtml) {
	throw new Error(`No compiledContent() for TypeDoc README: ${typedocPath}`);
}

const baseUrl = `/docs/${rel}`;

function rewriteRelativeLinks(html, base) {
	const regex = /href="(?!https?:\/\/|\/|#)([^"]+)"/g;
	return html.replace(regex, (_m, relHref) => `href="${base}/${relHref}"`);
}

const fixedHtml = rewriteRelativeLinks(rawHtml, baseUrl);
---

<div set:html={fixedHtml} />
